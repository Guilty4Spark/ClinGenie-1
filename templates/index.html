<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Welcome to ClinGenie</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="static/css/cg.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">


  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.js"></script>

  <script src="/static/js/cg.js"></script>


  <!-- update the version number as needed -->
  <!-- <script defer src="/__/firebase/9.22.1/firebase-app-compat.js"></script> -->
  <!-- include only the Firebase features as you need -->
  <!--   <script defer src="/__/firebase/9.22.1/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/9.22.1/firebase-database-compat.js"></script>
  <script defer src="/__/firebase/9.22.1/firebase-firestore-compat.js"></script>
  <script defer src="/__/firebase/9.22.1/firebase-functions-compat.js"></script>
  <script defer src="/__/firebase/9.22.1/firebase-messaging-compat.js"></script>
  <script defer src="/__/firebase/9.22.1/firebase-storage-compat.js"></script>
  <script defer src="/__/firebase/9.22.1/firebase-analytics-compat.js"></script>
  <script defer src="/__/firebase/9.22.1/firebase-remote-config-compat.js"></script>
  <script defer src="/__/firebase/9.22.1/firebase-performance-compat.js"></script> -->
  <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
  <!-- <script defer src="/__/firebase/init.js?useEmulator=true"></script> -->

</head>

<body>

  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Save Query</h2>
      <form id="queryForm" class="center-form">
        <input type="text" id="queryName" name="queryName" placeholder="Enter query name" required>
        <input type="submit" value="Submit" onclick="submitSave()">
      </form>
    </div>
  </div>


  <div id="spinner" class="hide-spinner">
    <div class="spinner-container">
      <div class="spinner-border text-primary" role="status">
      </div>
      <div class="overlay"></div>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">

      <a class="navbar-brand d-sm-none" href="#"><img src="/static/img/iqvia.jpg" alt="ClinGenie" width="30"
          height="24"></a>
      <a class="navbar-brand d-none d-sm-block" href="#"><img src="/static/img/iqvia.jpg" alt="ClinGenie" width="100"
          height="30">ClinGenie</a>

      <div class="d-flex">

        <div class="dropdown me-1">
          <button class="btn btn-secondary" type="button" aria-expanded="false" id="user">
            IQVIA User
          </button>
          <!--           <ul class="dropdown-menu" id="userDropdown">
                <li><a class="dropdown-item" href="#">Fredrick, Sales</a></li>
                <li><a class="dropdown-item" href="#">Patricia, Finance</a></li>
                <li><a class="dropdown-item" href="#">Brenda, HR</a></li>
              </ul> -->
        </div>

        <!-- Button trigger modal -->
        <div class="btn-group">
          <button id="dropdownMenuButton" type="button" class="btn btn-primary dropdown-toggle"
            data-bs-toggle="dropdown" aria-expanded="false">
            Disease dataset
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item active" value="0" onclick="updateButton(this)">Disease dataset</a></li>
            <li><a class="dropdown-item" value="1" onclick="updateButton(this)">Health dataset</a></li>
            <li><a class="dropdown-item" value="2" onclick="updateButton(this)">Sleep dataset</a></li>
          </ul>
        </div>

        &nbsp;
      </div>
    </div>
  </nav>


  <div class="sidebar" id="sidebar">
    <div class="heading">History</div>
  </div>


  <div class="container">

    <h1>Welcome to ClinGenie</h1>
    <p class="text-success-emphasis">This is a ChatGPT POC for querying SQL databases in natural language and
      generating reports and charts.
      Provide your query relevant to the database chosen and get your responses back
      <br />
      <b>(c) Aravind Ramachandran, Aby George, N Venkatraj, IQVIA, 2023</b>
    </p>

    <!-- A multi-line input spanning the full width of the screen that is responsive -->
    <div class="border border-dark rounded-3 mb-1 sticky-bar">
      <div class="input-group">
        <textarea class="form-control" aria-label="With textarea" id="query"
          placeholder="Enter your query here"></textarea>
        <button class="btn btn-success" type="button" id="query-button" onclick="submitQuery()">Submit</button>
        <button class="btn btn-warning" type="button" id="save-button" onclick="saveQuery()">Save</button>
        <button class="btn btn-info" type="button" id="toggleLLM-button" onclick="toggleLLMResult()">LLM Output</button>
      </div>
    </div>

    <!--  LLM Output -->
    <div class="border border-dark rounded-3 mb-1" id="llmOutput" placeholder="LLM Output will appear here"
      style="overflow-y: scroll; height: 35vh; display: none" ;>
    </div>


    <!-- Create a div that contains two columns with the first column containing the SQL query and the second column containing the result -->
    <div class="row">
      <div class="col-12">
        <div class="border border-dark rounded-3 mb-1" style="height: 80vh; overflow:auto;" id="result">
          <table id="dataTable" class="display" style="width: 90%; height: 90%;">
            <thead>
              <tr>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
      <div class="col-12">
        <div class="border border-dark rounded-3 mb-1" style="height: 90vh; overflow:auto;" id="chart">
          <!-- Create a row of icons on the top of the div -->
          <div class="row d-flex justify-content-center">
            <div class="col-1">
              <button type="button" id="barChartButton" class="btn btn-outline-secondary" id="bar-chart"
                onclick="createBarChart()">
                <img src="/static/img/bar-chart.png" alt="Bar Chart" width="30" height="30">
              </button>
            </div>
            <div class="col-1">
              <button type="button" class="btn btn-outline-secondary" id="bar-chart"
                onclick="createHorizontalBarChart()">
                <img src="/static/img/horizontal-bar-chart.png" alt="Bar Chart" width="30" height="30">
              </button>
            </div>
            <div class="col-1">
              <button type="button" class="btn btn-outline-secondary" id="pie-chart" onclick="createPieChart()">
                <img src="/static/img/pie-chart.png" alt="Pie Chart" width="30" height="30">
              </button>
            </div>
            <div class="col-1">
              <button type="button" class="btn btn-outline-secondary" id="line-chart" onclick="createLineChart()">
                <img src="/static/img/line-chart.png" alt="Line Chart" width="30" height="30">
              </button>
            </div>
            <div class="col-2">
              <!-- Create a dropdown that will hold the list of dimensions -->
              <button class="btn btn-secondary dropdown-toggle" type="button" id="dimensionsDropdown"
                data-bs-toggle="dropdown" aria-expanded="false">
                Dimensions
              </button>
              <ul class="dropdown-menu" id="dimensionsDropdownMenu">
              </ul>
            </div>
            <div class="col-2">
              <!-- Create a dropdown that will hold the list of dimensions -->
              <button class="btn btn-secondary dropdown-toggle" type="button" id="valuesDropdown"
                data-bs-toggle="dropdown" aria-expanded="false">
                Values
              </button>
              <ul class="dropdown-menu" id="valuesDropdownMenu">
              </ul>
            </div>
          </div>

          <!-- Create a canvas for the chart -->
          <div class="row d-flex justify-content-center align-items-center" style="height: 70vh;">
            <canvas id="myChart" width="90%" height="75%"></canvas>
          </div>


        </div>

        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog" id="dataset-modal">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Choose from available datasets:</h1>
              </div>
              <div class="modal-body">
                <div class="btn-group-vertical" role="group" aria-label="Vertical radio toggle button group">
                  <input type="radio" class="btn-check" name="vbtn-radio" id="vbtn-radio1" autocomplete="off"
                    value="Finance Dataset">
                  <label class="btn btn-outline-info" for="vbtn-radio1">This dataset contains all the
                    financial
                    information for the last 20 years. Income, expenses, assets, liabilities, transactions,
                    pricing, etc are all contained in this dataset.</label>
                  <input type="radio" class="btn-check" name="vbtn-radio" id="vbtn-radio2" autocomplete="off"
                    value="HR Dataset">
                  <label class="btn btn-outline-info" for="vbtn-radio2">Contains HR data for the last 7 years,
                    including hires, promotions, salaries, inter-department moves, terminations and
                    voluntary
                    separations.</label>
                  <input type="radio" class="btn-check" name="vbtn-radio" id="vbtn-radio3" autocomplete="off"
                    value="Oncology Dataset">
                  <label class="btn btn-outline-info" for="vbtn-radio3">Clinical data from multiple oncology
                    studies for the last 10 years in US & Europe.</label>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

      </div>

      <script>

        var local = window.location.hostname == "localhost";
        var globalData = [];
        var globalCols = [];
        var databaseValue = "0";

        var user = $("#user").text();
        var dataset = $("#dataset").text();

        function updateButton(element) {
          var button = document.getElementById('dropdownMenuButton');
          button.textContent = element.textContent;
          databaseValue = element.getAttribute('value');

          button.classList.remove('blue-background', 'red-background', 'green-background');
          switch (databaseValue) {
            case '0':
              button.classList.add('blue-background');
              break;
            case '1':
              button.classList.add('red-background');
              break;
            case '2':
              button.classList.add('green-background');
              break;
            default:
              // If the value is not recognized, you can handle it here or apply a default color.
              break;
          }
        }

        function changeUser(user) {
          document.getElementById("userDropdown").textContent = user;
        }

        $("#userDropdown li a").click(function () {
          $("#user").text($(this).text());
          user = $(this).text();
        });

        $(".btn-check").click(function () {
          $("#dataset").text($(this).val());
          dataset = $(this).val();
        });

        function submitQuery() {
          $("#spinner").removeClass("hide-spinner");
          if (dataTable)
            dataTable.destroy();
          $("#dataTable").find('thead tr').empty();
          $("#dataTable").find('tbody').empty();
          $("#dimensionDropdownMenu").empty();
          $("#valuesDropdownMenu").empty();

          //$("#dataTable").empty();
          try {
            myChart.destroy();
          } catch (error) {
            //console.log(error);
          }
          $("#myChart").empty();

          $("#llmOutput").empty();

          var query = $("#query").val();
          //Fetch the results by making an API call to /query endpoint
          //Display the results in the div

          const gptEndPoint = "http://127.0.0.1:5000/gpt/completions";
          fetch(gptEndPoint, {
            method: "POST",
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              query,
              databaseValue
            })
          }).then((response) => {
            try {
              return response.json();
            } catch (error) {
              $("#llmOutput").text(JSON.stringify(error));
              $("#spinner").addClass("hide-spinner");
              return;
            }
          }).then((data) => {
            const llmOutput = `
            <b>SQL:</b> ${data.choices[0].message.content}<br>
            --------------------------------<br>
            <b>Usage:</b> Prompt Tokens ${data.usage.prompt_tokens}, Completion Tokens ${data.usage.completion_tokens}, Total Tokens ${data.usage.total_tokens}<br>
            <b>Cost:</b> @$0.03/1K Prompt Tokens = ${getCents(data.usage.prompt_tokens / 1000 * 0.03)}c, @$0.06/1K Completion Tokens = ${getCents(data.usage.completion_tokens / 1000 * 0.06)}c, Total ${getCents((data.usage.prompt_tokens / 1000 * 0.03) + (data.usage.completion_tokens / 1000 * 0.06))}c<br>
            --------------------------------<br>
            <b>Created:</b> ${new Date(data.created * 1000)}, 
            <b>ID:</b> ${data.id}<br>
            <b>Model:</b> ${data.model},
            <b>Object:</b> ${data.object}<br>
          `;
            $("#llmOutput").html(llmOutput);

            //Now try and get the SQL results through a separate call
            var sql = data.choices[0].message.content;
            //Sometimes the output comes as text with triple backquote enclosed SQL statement in it. Handle that
            sql = SQLfromLLMOutput(sql) || sql;
            fetchData(query, sql);
          });
        }

        function fetchData(query, sql) {

          const sqlEndPoint = "http://127.0.0.1:5000/sql/query";
          fetch(sqlEndPoint, {
            method: "POST",
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              query,
              sql: SQLfromLLMOutput(sql) || sql,
              databaseValue
            })
          }).then((response) => {
            try {
              return response.json();
            } catch (error) {
              $("#dataTable").find('thead tr').text(JSON.stringify(error));
              $("#spinner").addClass("hide-spinner");
            }
          }).then((data) => {
            //Store result in memory to use for charting
            if (data.status === 'success') {
              if (data.type === 'table') {
                globalData = data.data;
                globalCols = data.columnNames;
                createTable();
              } else {
                //Its a text output
                data = data.data;
                const addLlmOutput = `
            --------------------------------<br>
            <b>Additional Usage for textifying output</b><br>
            --------------------------------<br>
            <b>Usage:</b> Prompt Tokens ${data.usage.prompt_tokens}, Completion Tokens ${data.usage.completion_tokens}, Total Tokens ${data.usage.total_tokens}<br>
            <b>Cost:</b> @$0.03/1K Prompt Tokens = ${getCents(data.usage.prompt_tokens / 1000 * 0.03)}c, @$0.06/1K Completion Tokens = ${getCents(data.usage.completion_tokens / 1000 * 0.06)}c, Total ${getCents((data.usage.prompt_tokens / 1000 * 0.03) + (data.usage.completion_tokens / 1000 * 0.06))}c<br>
            --------------------------------<br>
            <b>Created:</b> ${new Date(data.created * 1000)}, 
            <b>ID:</b> ${data.id}<br>
            <b>Model:</b> ${data.model},
            <b>Object:</b> ${data.object}<br>
          `;
                $("#llmOutput").append(addLlmOutput);
                //$("#dataTable").find('thead tr').append(data.choices[0].message.content);
                globalData = [[data.choices[0].message.content]];
                globalCols = [''];
                createTable();
              }
            } else {
              $("#dataTable").find('thead tr').text(data.message);
            }
            $("#spinner").addClass("hide-spinner");
          });
        }

        var dataTable = null;
        function createTable() {

          const colorArray = [
            'white',
            'lightgray',
          ];

          if (globalData.length == 0) {
            $("#dataTable").find('thead tr').append(`<th>No data found</th>`);
            return;
          }

          dataTable = $("#dataTable").DataTable({
            data: dtFormatData(globalData, globalCols),
            columns: dtFormatCols(globalCols),
            fixedHeader: {
              header: true,
            },
            createdRow: function (row, data, dataIndex) {
              const color = colorArray[dataIndex % 0]; // Cycle through colors if there are more rows than colors
              $(row).css('background-color', color);
            }
          })

          createBarChart();
        }

        function isNumeric(n) {
          return !isNaN(parseFloat(n)) && isFinite(n);
        }

        function getCents(x) {
          return Number((Math.round(x * 100) / 100).toFixed(2)) * 100;
        }

        function createBarChart() { chartSetup('bar') }
        function createHorizontalBarChart() { chartSetup('horizontalBar') }
        function createLineChart() { chartSetup('line') }
        function createPieChart() { chartSetup('pie') }
        var myChart;

        function chartSetup(chartType) {

          if (globalData.length == 0) {
            return;
          }

          let dimensions = [], values = [], curDim = 0, curVal = 0;
          for (let i = 0; i < globalData[0].length; i++) {
            if (isNumeric(globalData[0][i]))
              values.push(globalCols[i]);
            dimensions.push(globalCols[i]);
          }

          curDim = globalCols.indexOf(dimensions[curDim]), curVal = globalCols.indexOf(values[curVal]);
          createChart(chartType, curDim, curVal);

          $("#dimensionsDropdownMenu").empty();
          $("#valuesDropdownMenu").empty();
          for (let i = 0; i < dimensions.length; i++) {
            $("#dimensionsDropdownMenu").append(`<option value="${dimensions[i]}" onclick="createChart('${chartType}', ${globalCols.indexOf(dimensions[i])}, ${curVal});$('#dimensionsDropdownMenu').removeClass('show')">${formatHeader(dimensions[i])}</option>`);
          }
          for (let i = 0; i < values.length; i++) {
            $("#valuesDropdownMenu").append(`<option value="${values[i]}" onclick="createChart('${chartType}', ${curDim}, ${globalCols.indexOf(values[i])});$('#valuesDropdownMenu').removeClass('show')">${formatHeader(values[i])}</option>`);
          }


        }

        function createChart(chartType, dimIdx, valIdx) {

          try {
            myChart.destroy();
          } catch (error) {
            //console.log(error);
          }

          if (dimIdx === -1 || valIdx === -1) {
            return;
          }

          var canvas = document.getElementById('myChart');
          var ctx = canvas.getContext('2d');
          // ##############
          const containerWidth = canvas.parentNode.clientWidth;
          const containerHeight = canvas.parentNode.clientHeight;
          canvas.width = containerWidth;
          canvas.height = containerHeight;
          const Xcenter = canvas.width / 2;
          const Ycenter = canvas.height / 2;
          ctx.translate(Xcenter, Ycenter);
          // ##############
          let labels, data;

          /*
          if (globalData.length > 10) {
            let sortedData = [...globalData].sort((a, b) => b[Object.keys(globalData[0])[1]] - a[Object.keys(globalData[0])[1]]);

            let top10 = sortedData.slice(0, 10);
            let rest = sortedData.slice(10);
            let restSum = rest.reduce((sum, e) => sum + e[Object.keys(globalData[0])[1]], 0);

            rest = { [Object.keys(globalData[0])[0]]: 'Others', [Object.keys(globalData[0])[1]]: restSum };

            data = [...top10, rest].map(e => e[Object.keys(globalData[0])[1]]);
            labels = [...top10, rest].map(e => e[Object.keys(globalData[0])[0]]);
          } else {
            data = globalData.map(e => e[Object.keys(globalData[0])[1]]);
            labels = globalData.map(e => e[Object.keys(globalData[0])[0]]);
          }
            */
          labels = globalData.map(e => e[Object.keys(globalData[0])[dimIdx]]);
          data = globalData.map(e => e[Object.keys(globalData[0])[valIdx]]);
          //} 

          if (chartType === 'pie') {
            ctx.translate(canvas.width / 2, canvas.height / 2);
          }

          myChart = new Chart(ctx, {
            type: chartType === 'horizontalBar' ? 'bar' : chartType,
            data: {
              labels: labels,
              datasets: [{
                label: formatHeader(globalCols[dimIdx]),
                data: data,
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: chartType === 'horizontalBar' ? 'y' : 'x',
              scales: {
                y: {
                  beginAtZero: true
                }
              },
            },
          });

        }

        function toggleLLMResult() {
          var display = $("#llmOutput").css('display');
          if (display === 'none') {
            $("#llmOutput").css('display', 'block');
          } else {
            $("#llmOutput").css('display', 'none');
          }
        }



        <!--  ####################    Code to review    ######################     -->

        const fetchHistory = async () => {
          try {
            const response = await fetch('/data');
            const data = await response.json();
            return data;
          } catch (error) {
            console.error(error);
          }
        };


        const populateSidebar = async () => {
          const sidebar = document.getElementById('sidebar');
          const data = await fetchHistory();

          data.forEach((row) => {
            const entry = document.createElement('div');
            entry.classList.add('entry');

            const link = document.createElement('a');
            link.textContent = `${row.shortName}.`;
            link.appendChild(document.createElement('br'));
            link.append(`[${dispDate(row.refreshTime)}]`);
            link.href = `#${row.id}`;
            link.id = row.id;

            link.addEventListener('click', () => {
              handleRowClick(row);
            });

            const trashIcon = document.createElement('i');
            trashIcon.classList.add('fas', 'fa-trash-alt', 'trash-icon');
            trashIcon.style.display = 'none';

            const refreshIcon = document.createElement('i');
            refreshIcon.classList.add('fas', 'fa-sync-alt', 'refresh-icon');
            refreshIcon.style.display = 'none';
            let tooltipText = document.createElement('span');
            tooltipText.classList.add('tooltip-text');
            let currentDateTime = `${row.refreshTime}`;
            var convertedDateTime = new Date(currentDateTime);
            var hours = String(convertedDateTime.getUTCHours()).padStart(2, '0');
            var minutes = String(convertedDateTime.getUTCMinutes()).padStart(2, '0');
            var seconds = String(convertedDateTime.getUTCSeconds()).padStart(2, '0');
            var day = String(convertedDateTime.getUTCDate()).padStart(2, '0');
            var month = String(convertedDateTime.getUTCMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            var finalTime = `Last saved at:\nTime : ${hours}::${minutes}::${seconds}\nDate : ${day}/${month}`;
            console.log(`This is the date time in question : ${finalTime}`)
            tooltipText.innerText = finalTime;
            refreshIcon.appendChild(tooltipText);
            let textLength = tooltipText.innerText.length;

            refreshIcon.addEventListener('click', () => {
              refreshQuery(row.id, row.data, row.question, row.datasetoption, tooltipText);
            });

            entry.addEventListener('mouseover', () => {
              trashIcon.style.display = 'inline-block';
              refreshIcon.style.display = 'inline-block';
            });
            entry.addEventListener('mouseout', () => {
              trashIcon.style.display = 'none';
              refreshIcon.style.display = 'none';
            });
            trashIcon.addEventListener('click', () => {
              handleDelete(row.id);
            });

            entry.appendChild(link);
            entry.appendChild(trashIcon);
            entry.appendChild(refreshIcon);
            sidebar.appendChild(entry);
          });
        };


        const handleRowClick = (row) => {

          $("#query").empty();
          $("#query").val(row.question);
          $("#llmOutput").html(row.data);
          if (dataTable)
            dataTable.destroy();
          $("#dataTable").find('thead tr').empty();
          $("#dataTable").find('tbody').empty();

          databaseValue = row.datasetoption;
          databaseValue_int = parseInt(databaseValue);
          var dropdown = document.querySelector('.dropdown-menu');
          var dropdownItems = dropdown.getElementsByTagName('li');
          for (var i = 0; i < dropdownItems.length; i++) {
            var valueAttribute = dropdownItems[i].querySelector('.dropdown-item').getAttribute('value');
            var elementToSelect = document.querySelector('.dropdown-menu li a[value="' + databaseValue + '"]');
            var value = parseInt(valueAttribute);
            if (value === databaseValue_int) {
              updateButton(elementToSelect);
            }
          }

          globalData = JSON.parse(row.rawdata);
          globalCols = JSON.parse(row.columnnames);
          createTable();

        };

        function handleDelete(rowId) {

          $("#spinner").removeClass("hide-spinner");

          fetch('/data/delete', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rowId: rowId })
          })
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to delete the row.');
              }
              document.getElementById(rowId).remove();
              window.location.reload();
              $("#spinner").addClass("hide-spinner");
            })
            .catch(error => {
              console.log('Error deleting row:', error);
            });
        }


        function refreshQuery(rowId, rowData, question, datasetOption, toolTipElement) {
          var parser = new DOMParser();
          var doc = parser.parseFromString(rowData, "text/html");
          var sqlTag = doc.querySelector('b');
          var sqlQuery = sqlTag.nextSibling.textContent.trim();
          sqlQuery = SQLfromLLMOutput(sqlQuery) || sqlQuery;

          databaseValue = datasetOption;
          var ineteger_db_value = parseInt(databaseValue);
          var dropdown = document.querySelector('.dropdown-menu');
          var dropdownItems = dropdown.getElementsByTagName('li');
          for (var i = 0; i < dropdownItems.length; i++) {
            var valueAttribute = dropdownItems[i].querySelector('.dropdown-item').getAttribute('value');
            var elementToSelect = document.querySelector('.dropdown-menu li a[value="' + databaseValue + '"]');
            var value = parseInt(valueAttribute);
            if (value === ineteger_db_value) {
              updateButton(elementToSelect);
            }
          }

          if (dataTable)
            dataTable.destroy();
          $("#dataTable").find('thead tr').empty();
          $("#dataTable").find('tbody').empty();
          try {
            myChart.destroy();
          } catch (error) {
            console.log(error);
          } $("#myChart").empty();
          $("#llmOutput").empty();
          $("#llmOutput").html(rowData);

          fetchData(question, sqlQuery);

          let now = new Date();
          let hours = String(now.getHours()).padStart(2, '0');
          let minutes = String(now.getMinutes()).padStart(2, '0');
          let seconds = String(now.getSeconds()).padStart(2, '0');
          let formattedTime = `Last refresh at: ${hours}:${minutes}:${seconds}`;
          let day = String(now.getDate()).padStart(2, '0');
          let month = String(now.getMonth() + 1).padStart(2, '0'); 
          let formattedDate = ` : ${day}/${month}`;
          let completeTime = formattedTime + " " + formattedDate;
          let newTooltipText = `${completeTime}`;

          fetch('/data/update', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rowId: rowId,
               completeTime: new Date() })
          })
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to update the refresh time');
              }
              toolTipElement.innerText = newTooltipText;
              $("#spinner").addClass("hide-spinner");
            })
            .catch(error => {
              console.log('Error updating refresh time:', error);
            });

        }

        var modal = document.getElementById("myModal");
        var span = document.getElementsByClassName("close")[0];
        var form = document.getElementById("queryForm");
        var queryName;

        let dataStore = null;
        var saveEndPoint = "http://127.0.0.1:5000/save";


        function saveQuery() {
          var modal = document.getElementById('myModal');
          if (modal) {
            modal.style.display = "block";
          }
        }

        span.onclick = function () {
          modal.style.display = "none";
        }

        window.onclick = function (event) {
          if (event.target == modal) {
            modal.style.display = "none";
          }
        }


        function submitSave() {
          shortName = $("#queryName").val();
          modal.style.display = "none";

          $("#spinner").removeClass("hide-spinner");

          var question = $("#query").val();
          var llmOutputDiv = document.getElementById('llmOutput');
          var data = llmOutputDiv.innerHTML.toString();
          let globalData_string = JSON.stringify(globalData);
          let globalCols_string = JSON.stringify(globalCols);

          let now = new Date();
          let hours = String(now.getHours()).padStart(2, '0');
          let minutes = String(now.getMinutes()).padStart(2, '0');
          let seconds = String(now.getSeconds()).padStart(2, '0');
          let formattedTime = `Saved at: ${hours}:${minutes}:${seconds}`;
          let day = String(now.getDate()).padStart(2, '0');
          let month = String(now.getMonth() + 1).padStart(2, '0'); 
          let formattedDate = ` : ${day}/${month}`;
          let completeTime = formattedTime + " " + formattedDate;

          console.log(`The time and date of the save is : ${completeTime}`);
          console.log(`question is : ${question}`);
          console.log(`llmoutput is : ${llmOutputDiv}`);

          fetch(saveEndPoint, {
            method: "POST",
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              shortName,
              question,
              data,
              globalData_string,
              globalCols_string,
              databaseValue,
              completeTime : new Date(),
            })
          }).then((response) => {
            try {
              console.log(`Sent my data`);
              return response.json();
            } catch (error) {
              $("#spinner").addClass("hide-spinner");
            }
          }).then((data) => {
            window.location.reload();
            $("#spinner").addClass("hide-spinner");
          });
        }

        populateSidebar();


        document.addEventListener('DOMContentLoaded', function () {
          //const loadEl = document.querySelector('#load');
          // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
          // // The Firebase SDK is initialized and available here!
          //
          // firebase.auth().onAuthStateChanged(user => { });
          // firebase.database().ref('/path/to/ref').on('value', snapshot => { });
          // firebase.firestore().doc('/foo/bar').get().then(() => { });
          // firebase.functions().httpsCallable('yourFunction')().then(() => { });
          // firebase.messaging().requestPermission().then(() => { });
          // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
          // firebase.analytics(); // call to activate
          // firebase.analytics().logEvent('tutorial_completed');
          // firebase.performance(); // call to activate
          //
          // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

          /*         try {
                    let app = firebase.app();
                    let features = [
                      'auth',
                      'database',
                      'firestore',
                      'functions',
                      'messaging',
                      'storage',
                      'analytics',
                      'remoteConfig',
                      'performance',
                    ].filter(feature => typeof app[feature] === 'function');
                    console.log(`Firebase SDK loaded with ${features.join(', ')}`);
                    //loadEl.textContent = `Firebase SDK loaded with ${features.join(', ')}`;
                  } catch (e) {
                    console.error(e);
                    //loadEl.textContent = 'Error loading the Firebase SDK, check the console.';
                  } */
        });
      </script>
</body>

</html>